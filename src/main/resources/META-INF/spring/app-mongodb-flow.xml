<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:int-mongo="http://www.springframework.org/schema/integration/mongodb"
       xsi:schemaLocation="http://www.springframework.org/schema/integration
        http://www.springframework.org/schema/integration/spring-integration.xsd
        http://www.springframework.org/schema/task
        http://www.springframework.org/schema/task/spring-task.xsd
        http://www.springframework.org/schema/integration/mongodb
        http://www.springframework.org/schema/integration/mongodb/spring-integration-mongodb.xsd
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd">

    <beans profile="mongodb">

        <int:channel id="workingMongoDBChannel">
            <int:dispatcher task-executor="poolThreadMongoDB"/>
        </int:channel>

        <int:chain input-channel="workingMongoDBChannel">
            <int:filter ref="binaryArtifactFilter"/>
            <int:transformer expression="@thirdPartyArtifactEnricher.enrich(payload, headers['repo.url'])"/>
            <int:transformer ref="metadataArtifactTransformer"/>
            <int-mongo:outbound-channel-adapter
                    mongo-converter="mappingConverter"
                    mongodb-factory="mongoDbFactory"
                    collection-name="artifacts"/>
        </int:chain>
        <task:executor id="poolThreadMongoDB" pool-size="10"/>

        <bean id="binaryArtifactFilter"
              class="com.boissinot.maven.util.mongoimport.service.mongodb.integration.BinaryArtifactFilter"/>
        <bean id="thirdPartyArtifactEnricher"
              class="com.boissinot.maven.util.mongoimport.service.mongodb.integration.ThirdPartyArtifactEnricher"/>
    </beans>

    <beans profile="couchbase">
        <bean id="metadataArtifactTransformer"
              class="com.boissinot.maven.util.mongoimport.service.mongodb.integration.MetadataArtifactTransformer">
            <constructor-arg name="couchbaseTemplate" ref="couchbaseTemplate"/>
        </bean>

    </beans>
</beans>